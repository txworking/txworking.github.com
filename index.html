
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Darcy Tang&#8217;s Blog</title>
  <meta name="author" content="Darcy Tang">

  
  <meta name="description" content="ElasticSearch for Apache Hadoop是ES提供的工具库，让Hadoop、Pig、Hive等可以比较原生的方式去和ES交互。
目前提供了mapreduce、hive、pig、cascading、spark、storm的集成。 下面以Spark为例， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://txworking.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Darcy Tang's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Darcy Tang&#8217;s Blog</a></h1>
  
    <h2>记录一点编程心得</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="txworking.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about-me">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/14/use-spark-with-elasticsearch/">使用Spark对ElasticSearch进行读取</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-14T17:22:00+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:22 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ElasticSearch for Apache Hadoop是ES提供的工具库，让Hadoop、Pig、Hive等可以比较原生的方式去和ES交互。
目前提供了mapreduce、hive、pig、cascading、spark、storm的集成。</p>

<p>下面以Spark为例，演示如何利用这个工具库去读取ES记录</p>

<p><a href="http://www.elasticsearch.org/guide/en/elasticsearch/hadoop/current/spark.html">官方指南</a></p>

<h2>安装</h2>

<p>我使用的是spark-shell交互式环境进行的测试，所以需要手动下载elasticsearch-hadoop的jar包。
在maven项目中可以通过添加</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>org.elasticsearch<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>elasticsearch-hadoop<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>2.1.0.Beta3<span class="nt">&lt;/version&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是包含了所有支持的jar包，也可以下载单独的spark支持包。</p>

<p>对于Spark，还需要下载Kryo，来替代Spark自带的序列化包。</p>

<p>最后elasticsearch-hadoop只支持Java 1.7以上版本，所以需要看看Java环境是否匹配。</p>

<p>启动spark-shell时，使用以下命令加载特定jar包</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>./bin/spark-shell -jars ./elasticsearch-hadoop-2.1.0.Beta3.jar;./kryo-3.0.0/jar
</span></code></pre></td></tr></table></div></figure>


<p>指定序列化工具</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>import com.esotericsoftware.kryo.KryoSerializable
</span><span class='line'>import org.apache.spark.SparkConf
</span><span class='line'>
</span><span class='line'>val conf = new SparkConf()
</span><span class='line'>conf.set(&quot;spark.serializer&quot;, classOf[KryoSerializer].getName)
</span></code></pre></td></tr></table></div></figure>


<h2>读取</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>import org.apache.hadoop.conf.Configuration
</span><span class='line'>import org.elasticsearch.hadoop.mr.EsInputFormat
</span><span class='line'>import org.apache.hadoop.io.Text
</span><span class='line'>import org.apache.hadoop.io.MapWritable
</span><span class='line'>
</span><span class='line'>val conf = new Configuration()
</span><span class='line'>conf.set(&quot;es.resource&quot;, &quot;highrisk/blacklist&quot;) //指定读取的索引名称
</span><span class='line'>conf.set(&quot;es.nodes&quot;, &quot;127.0.0.1&quot;)
</span><span class='line'>conf.set(&quot;es.query&quot;, &quot;?q=me*&quot;)  //使用query字符串对结果进行过滤
</span><span class='line'>val esRDD = sc.newHadoopRDD(conf, classOf[EsInputFormat[Text, MapWritable]],
</span><span class='line'>                                  classOf[Text], classOf[MapWritable]))
</span><span class='line'>val docCount = esRDD.count();
</span></code></pre></td></tr></table></div></figure>


<p>读取出来的记录为key-value形式，key为Text类型，value为MapWritable类型。
接下来就可以利用Spark对esRDD进行各种map、flatmap、reduceByKey的操作了。</p>

<h2>写入</h2>

<p>参考<a href="http://chenlinux.com/2014/09/04/spark-to-elasticsearch/">用Spark处理数据导入ElasticSearch</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>import org.apache.spark.SparkConf
</span><span class='line'>import org.elasticsearch.spark._
</span><span class='line'>
</span><span class='line'>val conf = new SparkConf()
</span><span class='line'>conf.set(&quot;es.index.auto.create&quot;, &quot;true&quot;)
</span><span class='line'>conf.set(&quot;es.nodes&quot;, &quot;127.0.0.1&quot;)
</span><span class='line'>
</span><span class='line'>val numbers = Map(&quot;one&quot; -&gt; 1, &quot;two&quot; -&gt; 2, &quot;three&quot; -&gt; 3)
</span><span class='line'>val airports = Map(&quot;OTP&quot; -&gt; &quot;Otopeni&quot;, &quot;SFO&quot; -&gt; &quot;San Fran&quot;)
</span><span class='line'>sc.makeRDD(Seq(numbers, airports)).saveToEs(&quot;spark/docs&quot;)
</span></code></pre></td></tr></table></div></figure>


<p>目前elasticsearch-hadoop对Spark的支持还比较简单，想要对记录进行过滤就只有通过query字符串或者全部读取后在Spark中过滤，对规模比较大的索引或者复杂的过滤查询不友好。</p>

<h2>配置</h2>

<p>主要的配置
* es.resource
* es.resource.read    默认与es.resource相同
* es.resource.write   默认与es.resource相同
* es.nodes 默认为localhost
* es.port  默认为9200
* es.query 默认为none</p>

<p>完整的请查看<a href="http://www.elasticsearch.org/guide/en/elasticsearch/hadoop/current/configuration.html">Configuration</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/02/angular-plus-springmvc/">AngularJS+SpringMVC构建应用</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-01-02T13:33:00+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2014</span></span> <span class='time'>1:33 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>利用AngularJS和SpringMVC搭建一个简单的应用，AngularJS负责前端，SpringMVC作为后端提供REST API。</p>

<h2>SpringMVC的使用</h2>

<p>SpringMVC中可以很方便的使用<code>@RequestMapping</code>注解提供REST API。</p>

<p>最基本的使用代码如下所示：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Controller
</span><span class='line'>@RequestMapping(value = "/hello")
</span><span class='line'>public class MyController {
</span><span class='line'>
</span><span class='line'>  @RequestMapping(method=RequestMethod.GET)
</span><span class='line'>  @ResponseBody
</span><span class='line'>  public String getRoot(){
</span><span class='line'>
</span><span class='line'>    return "Hello World";
</span><span class='line'>
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  @RequestMapping(value="/{path}", method=RequestMethod.GET)
</span><span class='line'>  @ResponseBody
</span><span class='line'>  public String getValue(@PathVariable String path){
</span><span class='line'>    return "Path is " + path;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>使用<code>@Controller</code>注解指定当前类为SpringMVC的一个controller，使用<code>@RequestMapping</code>表明此controller会处理所有以<code>/hello</code>开头的URL。</p>

<p><code>@RequestMapping</code>最常用的两个参数就是<code>value</code>和<code>method</code>，分别指定了拦截的URL和请求方法。</p>

<p>MyController类中的两个方法还可以分别再使用<code>@RequestMapping(value)</code>再继续指定处理以hello为前缀的URL。例如<code>@RequestMapping(value="/{path}")</code>，可处理类似<code>/hello/path</code>的URL，并结合<code>@PathVariable</code>将path作为URL参数获取。</p>

<p>这个小Demo只是将SpringMVC作为后台REST API的提供方，也就是说只使用了MVC中的Controller和Model，View就交给AngularJS，所以使用<code>@ResponseBody</code>直接将方法返回值作为响应，不经过View的渲染啥的。</p>

<h2>简单的AngularJS应用</h2>

<p><a href="http://angularjs.org">AngularJS</a>是Google推出的前端MVC框架，也有完整的Controller、View、Model等概念，而且上手非常简单，熟悉几个html标签就能开始使用了。</p>

<p>建立AngularJS项目可以从GitHub上clone <a href="https://github.com/angular/angular-seed">angular-seed</a>。</p>

<p>核心的代码都在app目录中，其典型结构如下：</p>

<ul>
<li><code>css</code> 存放css文件</li>
<li><code>img</code> 存放图片</li>
<li><code>js</code> 存放js代码，我们自己的代码基本都在这儿，一般按照功能和层次划分为这样几个文件：app.js, controller.js, services.js, filters.js, directives.js, animations.js。从名字就可以看出分别是在对这些概念进行定义和使用</li>
<li><code>lib</code> 存放js库</li>
<li><code>partials</code> 存放html模板，angularjs发送到客户端的就是这些html模板</li>
</ul>


<h3>基本概念</h3>

<p>demo中涉及的几个概念：</p>

<ul>
<li>app</li>
<li>controller</li>
<li>service</li>
<li>router</li>
<li>resource</li>
<li>view</li>
<li>scope</li>
</ul>


<p>demo的基本功能就是在html模板中新建一个app和两个controller，然后自定义一个service使用REST API和SpringMVC后端交互操作hello这个resource，在controller中调用此service，html模板间的跳转通过router定义。</p>

<p><img src="http://docs.angularjs.org/img/guide/concepts-module-service.png" alt="Alt text" /></p>

<p>借用AngularJS官方的一张图来说明下关系：</p>

<p>在template中声明app，app包含controller，controller调用service，service操作resource。</p>

<p>层次和调用关系还是很清晰的，和Spring也差不多。</p>

<p>template、app、service、controller的具体代码如下</p>

<h4>template</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;!doctype html&gt;
</span><span class='line'>&lt;html lang="en" ng-app="myApp"&gt;
</span><span class='line'>&lt;body&gt;
</span><span class='line'>  &lt;div ng-view&gt;&lt;/div&gt;
</span><span class='line'>&lt;/body&gt;
</span><span class='line'>&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<h4>app</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>'use strict';
</span><span class='line'>
</span><span class='line'>// 新建myApp，并声明会使用ngRoute、myApp.services、myApp.controllers三个module
</span><span class='line'>// AngularJS会实现module的自动注入
</span><span class='line'>angular.module('myApp', [
</span><span class='line'>  'ngRoute',
</span><span class='line'>  'myApp.services',
</span><span class='line'>  'myApp.controllers'
</span><span class='line'>]).
</span><span class='line'>config(['$routeProvider', function($routeProvider) { // 配置app对应的URL路由，请求此URL时返回的view template和template对应的controller
</span><span class='line'>  $routeProvider.when('/hello', {templateUrl: 'partials/list.html', controller: 'ListCtrl'});
</span><span class='line'>  $routeProvider.when('/hello/:path', {templateUrl: 'partials/detail.html', controller: 'DetailCtrl'});
</span><span class='line'>  $routeProvider.otherwise({redirectTo: '/hello'});
</span><span class='line'>}]);
</span></code></pre></td></tr></table></div></figure>


<h4>service</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>'use strict';
</span><span class='line'>
</span><span class='line'>// 新建myService，并声明会使用ngResource这个module
</span><span class='line'>var myService = angular.module('myApp.services', ['ngResource']).
</span><span class='line'>  value('version', '0.1');
</span><span class='line'>// 新建Hello这个资源，并指定资源的访问路径和访问方法
</span><span class='line'>myService.factory('Hello', ['$resource',
</span><span class='line'>  function($resource){
</span><span class='line'>    return $resource('api/hello/:path', {}, {
</span><span class='line'>      list: {method:'GET', isArray:true}
</span><span class='line'>    });
</span><span class='line'>  }]);
</span></code></pre></td></tr></table></div></figure>


<h4>controller</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>'use strict';
</span><span class='line'>
</span><span class='line'>// 新建ListCtrl和DetailCtrl两个controller
</span><span class='line'>angular.module('myApp.controllers', []).
</span><span class='line'>  controller('ListCtrl', ['$scope', 'Hello', // 声明要使用Hello
</span><span class='line'>   function($scope, Hello) {
</span><span class='line'>    $scope.hello = Hello.list();             // 调用Hello服务的list方法，赋值给模板中的hello元素
</span><span class='line'>  }])
</span><span class='line'>  .controller('DetailCtrl', ['$scope', '$routeParams', 'Hello',
</span><span class='line'>   function($scope, $routeParams, Hello) {
</span><span class='line'>    $scope.hello = Hello.get({path:$routeParams.path}, function(hello){
</span><span class='line'>      $scope.detail = hello.detail;
</span><span class='line'>    });
</span><span class='line'>  }]);
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;div class="container-fluid"&gt;
</span><span class='line'>  &lt;div class="row-fluid"&gt;
</span><span class='line'>    &lt;div class="span10"&gt;
</span><span class='line'>      &lt;!--Body content--&gt;
</span><span class='line'>          &lt;p&gt;&lt;/p&gt;
</span><span class='line'>    &lt;/div&gt;
</span><span class='line'>  &lt;/div&gt;
</span><span class='line'>&lt;/div&gt;</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/02/ruby2-dot-0/">Ruby和Ruby2.0相关文章汇总</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-12-02T11:31:00+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2013</span></span> <span class='time'>11:31 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>记录一些Ruby和Ruby2.0的文章</p>

<h2>Ruby2.0相关</h2>

<ul>
<li><a href="http://rkh.im/ruby-2.1">Ruby2.1</a></li>
<li><a href="http://www.jstorimer.com/blogs/workingwithcode/8085491-nobody-understands-the-gil?utm_source=rubyweekly&amp;utm_medium=email">Ruby 2.0 by example</a></li>
<li><a href="http://crypt.codemancers.com/posts/2013-04-16-profile-ruby-apps-dtrace-part1/?utm_source=rubyweekly&amp;utm_medium=email">Profile Ruby 2.0 apps using DTrace - Part 1</a></li>
<li><a href="https://speakerdeck.com/shyouhei/whats-new-in-ruby-2-dot-0?utm_source=rubyweekly&amp;utm_medium=email">What&rsquo;s new in Ruby 2.0</a></li>
<li><a href="http://globaldev.co.uk/2013/03/ruby-2-0-0-in-detail/">Ruby 2.0 in details</a></li>
<li><a href="http://whitequark.org/blog/2013/04/14/unmentioned-features-of-ruby-2-dot-0/?utm_source=rubyweekly&amp;utm_medium=email">Unmentioned Features of Ruby 2.0</a></li>
<li><a href="http://tech.pro/tutorial/1149/understanding-method-lookup-in-ruby-20">Understand method lookup in Ruby 2.0</a> <a href="http://www.oschina.net/translate/understanding-method-lookup-in-ruby-20">译文</a></li>
<li><a href="http://www.confreaks.com/videos/1272-rubyconf2012-implementation-details-of-ruby-2-0-vm">Implementation Details of Ruby2.0 VM</a></li>
</ul>


<h2>Ruby相关</h2>

<ul>
<li><a href="http://www.jstorimer.com/blogs/workingwithcode/8085491-nobody-understands-the-gil?utm_source=rubyweekly&amp;utm_medium=email">Nobody understands the GIL</a></li>
<li><a href="http://www.sitepoint.com/series/comparing-ruby-background-processing-libraries/">Comparing Ruby Background Processing Libraries/</a></li>
<li><a href="http://www.ibm.com/developerworks/cn/opensource/os-cn-rubysbl/">理解Ruby Symbol</a></li>
<li><a href="http://patshaughnessy.net/2012/6/29/how-ruby-executes-your-code">How Ruby Executy Your Code</a></li>
<li><a href="http://globaldev.co.uk/2013/09/ruby-tips-part-1/">Ruby Tips Part 1</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/17/check-logfiles/">在Nagios中实时监控日志</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-08-17T17:30:00+08:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>5:30 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近需要利用Nagios对Linux和Windows上的某个日志文件进行实时的监控，虽然这个活由Nagios来做不太合适，但最后
还是记录一下找到的解决方案。</p>

<h2>Windows</h2>

<p>在Windows系统上使用NSClient++自带了对系统日志和日志文件的实时监控功能，只需要简单的配置下就可以使用了。当然还需要在服务器
上运行NSCA服务才能接收客户端主动推送的数据。</p>

<p>以下为开启对Windows系统日志监控的客户端配置，更详细配置可以参考<a href="http://blog.medin.name/blog/2012/03/20/real-time-event-log-monitoring-with-nsclient/">Real time event-log monitoring with NSClient++</a>和NSClient++的<a href="http://www.nsclient.org">文档</a></p>

<pre><code>[/modules]
CheckLogFile = enabled
CheckEventLog = enabled

[/settings/NSCA/client]
hostname=&lt;nagios_hostname&gt; # 需要和服务器端设定的nagios host一致

[/settings/NSCA/client/targets/default]
address=168.1.194.1  
password=nagios   # password和encryption配置需要和服务器端的nsca配置一致
encryption=1

[/settings/eventlog/real-time]
enabled = true

[/settings/eventlog/real-time/filters/run_log]  # run_log为nagios service名称
filter=type in ( 'warning', 'error') AND source = 'Puppet' 
target=NSCA
severity=OK
syntax=%type%: %strings%
</code></pre>

<h2>Linux</h2>

<h3>配合incron</h3>

<p>在nagios exchange里找到了<a href="labs.consol.de/nagios/check_logfiles/">check_logfiles</a>这个插件，配合<a href="http://inotify.aiken.cz/?section=incron&amp;page=about&amp;lang=en">incron</a>就可以实现实时的日志监控了。</p>

<p>incron是类似cron的工具，cron是基于时间，incron则是基于文件事件，底层使用了inotify系统调用。</p>

<p>以下是check_logfiles的配置文件，主要功能就在<code>supersmartscript</code>，意思就是在每找到一行新的日志信息时执行script指定的perl脚本。
类似的配置有<code>supersmartpostscript</code>，在一次检查完后执行perl脚本。
在脚本中也支持部分变量的调用，在$MACROS中定义即可在script中使用。
在这段配置里script部分调用系统命令，执行<code>send_nsca</code>发送监控信息到服务器。</p>

<pre><code>$scriptpath = '/usr/bin/nagios/libexec:/usr/local/nagios/bin';
$MACROS = {
    CL_NAGIOS_HOST_ADDRESS =&gt; '%server_ip%',
    CL_NSCA_HOSTNAME =&gt; '%node_name%',
    CL_NSCA_PORT =&gt; 5667,
    CL_NSCA_CONFIG_FILE =&gt; '%send_nsca.cfg%'
};
@searches = (
  {
    options =&gt; 'supersmartscript,noprotocol',
    tag =&gt; 'puppet',
    logfile =&gt; '%puppet_run_log%',
    criticalpatterns =&gt; [
      'Tongtech',
      'err'
    ],
    script =&gt; sub {
      (my $line = "$ENV{CHECK_LOGFILES_NSCA_HOSTNAME}\t$ENV{CHECK_LOGFILES_SERVICEDESC}\t$ENV{CHECK_LOGFILES_SERVICESTATEID}\t$ENV{CHECK_LOGFILES_SERVICEOUTPUT}");
      #system("echo '$line'");
      system("echo '$line'|%send_nsca% -H $ENV{CHECK_LOGFILES_NAGIOS_HOST_ADDRESS} -c $ENV{CHECK_LOGFILES_NSCA_CONFIG_FILE} " );
    }
  },
);
</code></pre>

<p>按照常规的<code>./configure &amp;&amp; make &amp;&amp; make install</code>安装好incron，使用incrontab -e 命令编辑，基本的格式为</p>

<pre><code>&lt;path-to-puppet_log&gt; MODIFY &lt;path-to-check_logfiles&gt; -f &lt;配置文件路径&gt; --rununique
# &lt;path&gt; &lt;mask&gt; &lt;command&gt;
# path - 监控的文件
# mask - 监控的文件事件，MODIFY表示文件有改变
# command - 监控到指定文件的指定事件后执行的命令
</code></pre>

<p>具体的使用可以参考此文章<a href="http://wlx.westgis.ac.cn/879/">incron的使用</a></p>

<p>这样利用incron监控puppet的日志文件，当文件有改变时执行check_logfiles检查，就会发送日志信息到服务器。
注意&ndash;rununique选项，如果不加此选项，文件改变可能会触发多次检查，check_logfiles就会发送重复的信息。</p>

<h3>只使用check_logfiles</h3>

<p>check_logfiles支持以daemon方式运行，所以可以指定较短的检查周期，实现实时发送。</p>

<p>之前的check_logfiles配置不变，只是不使用incron执行命令，直接在shell中执行</p>

<pre><code>&lt;path-to-check_logfiles&gt; -f &lt;配置文件路径&gt; --rununique --daemon 1
</code></pre>

<p>check_logfiles就会变成守护进程，每隔一秒检查一次日志文件，如果有新的日志写入，就发送到服务器。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/08/a-bug-of-facter/">Facter在Windows上的一个小问题</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-07-08T23:37:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>11:37 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近在Windows上使用Puppet，总是遇到一个诡异的问题：在某些机器上无法获得ipaddress这个fact，直接使用facter命令行也不行，而且显得完全没有规律。</p>

<p>具体情况是：</p>

<ul>
<li>facter 在所有机器上可以获得ipaddress</li>
<li>facter &ndash;puppet 在部分机器上出现 <strong>invalid address</strong> 错误</li>
</ul>


<p><strong>ipaddress</strong>这个fact是在facter/lib/facter/ipaddress.rb添加进来的。关键代码是:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Facter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:ipaddress</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="err">  </span><span class="n">confine</span> <span class="ss">:kernel</span> <span class="o">=&gt;</span> <span class="sx">%w{windows}</span>
</span><span class='line'><span class="err">  </span><span class="n">setcode</span> <span class="k">do</span>
</span><span class='line'><span class="err">    </span><span class="nb">require</span> <span class="s1">&#39;socket&#39;</span>
</span><span class='line'><span class="err">    </span><span class="no">IPSocket</span><span class="o">.</span><span class="n">getaddress</span><span class="p">(</span><span class="no">Socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">)</span>
</span><span class='line'><span class="err">  </span><span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>发现是<strong>IPSocket.getaddress</strong>函数不起作用，于是又把问题定位在Puppet自带的Ruby环境中的<strong>ipaddr.rb</strong>中，发现以下代码在某些机器上无法获得IP。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">alias</span> <span class="n">getaddress_orig</span> <span class="n">getaddress</span>
</span><span class='line'><span class="k">def</span> <span class="nf">getaddress</span> <span class="n">s</span><span class="err">   </span>
</span><span class='line'>  <span class="k">if</span> <span class="n">valid?</span> <span class="n">s</span>
</span><span class='line'>  <span class="err"> </span> <span class="n">s</span><span class="err">   </span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="err"> </span> <span class="n">getaddress_orig</span> <span class="n">s</span><span class="err">   </span>
</span><span class='line'>  <span class="k">end</span><span class="err"> </span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>一开始没发现哪有问题，后来仔细看了下<strong>valid</strong>中的正则表达式，发现不允许<strong>hostname</strong>中出现<strong>下划线</strong>。</p>

<p>之前一直没注意过这问题，所以测试主机的hostname都是随意命名的，所以才会出现部分主机可以通过验证，部分不行的情况。</p>

<p>不过也是现在才知道原来主机名规范有一条是不能带下划线。</p>

<p>Windows命名的时候完全没这个限制，但是在Ubuntu里使用<strong>hostname</strong>命令修改时，如果带下划线会直接提示错误。</p>

<p>很奇怪自己以前在Ubuntu上怎么没遇到过这个错误，难道就鬼使神差的从没使用过带下划线的主机名？</p>

<p>但是现在问题又来了，为什么facter都可以，facter &ndash;puppet就不行呢？</p>

<p>于是又研究了一遍facter的加载机制，在facter取值的部分折腾好久，最后发现和这部分没关系。是因为执行facter时没有加载<strong>facter/lib/facter/ipaddr.rb</strong>，ipaddr.rb中对<strong>IPSocket#getaddress</strong>的重写未生效，直接使用了Puppet自带Ruby中的socket.so中定义的<strong>IPSocket#getaddress</strong>，这个函数定义里面就没有对主机名的正则验证。</p>

<p>想来Puppet也是为了做多平台支持，所以加了一个MonkeyPatch，对主机名做了验证。</p>

<p>现在又绕回来了，&ndash;puppet 到底干了啥？</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err"> </span><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">load_puppet</span>
</span><span class='line'><span class="err">      </span><span class="nb">require</span> <span class="s1">&#39;puppet&#39;</span>
</span><span class='line'><span class="err">      </span><span class="no">Puppet</span><span class="o">.</span><span class="n">parse_config</span>
</span><span class='line'>
</span><span class='line'><span class="err">      </span><span class="c1"># If you&#39;ve set &#39;vardir&#39; but not &#39;libdir&#39; in your</span>
</span><span class='line'><span class="err">      </span><span class="c1"># puppet.conf, then the hook to add libdir to $:</span>
</span><span class='line'><span class="err">      </span><span class="c1"># won&#39;t get triggered.  This makes sure that it&#39;s setup</span>
</span><span class='line'><span class="err">      </span><span class="c1"># correctly.</span>
</span><span class='line'><span class="err">      </span><span class="k">unless</span> <span class="vg">$LOAD_PATH</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="no">Puppet</span><span class="o">[</span><span class="ss">:libdir</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="err">        </span><span class="vg">$LOAD_PATH</span> <span class="o">&lt;&lt;</span> <span class="no">Puppet</span><span class="o">[</span><span class="ss">:libdir</span><span class="o">]</span>
</span><span class='line'><span class="err">      </span><span class="k">end</span>
</span><span class='line'><span class="err">    </span><span class="k">rescue</span> <span class="no">LoadError</span> <span class="o">=&gt;</span> <span class="n">detail</span>
</span><span class='line'><span class="err">      </span><span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Could not load Puppet: </span><span class="si">#{</span><span class="n">detail</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'> <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>根据代码来看，只是把Puppet的<strong>libdir</strong>加入了<strong>\$LOAD_PATH</strong>。</p>

<p>这个libdir里面都是些自定义的facter、tyep和provider，似乎和ipaddr.rb完全没关系。</p>

<p>又卡在这儿想了半天，才发现思路错了。</p>

<p>ipaddr.rb虽然在lib目录下，但是不会自动加载，需要显式<strong>require</strong>。</p>

<p>于是注释掉</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;puppet&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用facter &ndash;puppet也就和正常一样了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/06/lambda-in-puppet-3-dot-2/">Puppet3.2的迭代器</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-07-06T00:29:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:29 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Puppet在最新的3.2版本中实现了lambda风格的迭代器语法，而且支持链式语法。当然要使用的话，需要在puppet.conf中启用parser=future</p>

<p>目前已经实现的有：</p>

<ul>
<li>each/foreach</li>
<li>slice</li>
<li>select</li>
<li>collect</li>
<li>reject</li>
<li>reduce</li>
</ul>


<p>含义和作用域与Ruby中的基本一致，基本用法也一致。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vg">$a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="o">]</span>
</span><span class='line'><span class="n">each</span><span class="p">(</span><span class="vg">$a</span><span class="p">)</span> <span class="o">|</span><span class="vg">$value</span><span class="o">|</span> <span class="p">{</span> <span class="n">notice</span> <span class="vg">$value</span> <span class="p">}</span> <span class="c1"># 迭代数组</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">3</span><span class="o">].</span><span class="n">select</span> <span class="o">|</span><span class="vg">$value</span><span class="o">|</span> <span class="p">{</span><span class="vg">$value</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="p">}</span><span class="o">.</span><span class="n">each</span> <span class="o">|</span><span class="vg">$value</span><span class="o">|</span> <span class="p">{</span> <span class="n">notice</span> <span class="vg">$value</span> <span class="p">}</span> <span class="c1"># 链式语法</span>
</span></code></pre></td></tr></table></div></figure>


<p>根据<a href="http://docs.puppetlabs.com/puppet/3/reference/lang_experimental_3_2.html#available-functions">说明</a>，也可以使用多种风格的语法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">each</span><span class="p">(</span><span class="vg">$x</span><span class="p">)</span>  <span class="o">|</span><span class="vg">$value</span><span class="o">|</span> <span class="p">{</span> <span class="err">…</span> <span class="p">}</span>
</span><span class='line'><span class="vg">$x</span><span class="o">.</span><span class="n">each</span>   <span class="o">|</span><span class="vg">$value</span><span class="o">|</span> <span class="p">{</span> <span class="err">…</span> <span class="p">}</span>
</span><span class='line'><span class="vg">$x</span><span class="o">.</span><span class="n">each</span><span class="p">()</span> <span class="o">|</span><span class="vg">$value</span><span class="o">|</span> <span class="p">{</span> <span class="err">…</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">slice</span><span class="p">(</span><span class="vg">$x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span><span class="vg">$value</span><span class="o">|</span> <span class="p">{</span> <span class="err">…</span> <span class="p">}</span>
</span><span class='line'><span class="vg">$x</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="o">|</span><span class="vg">$value</span><span class="o">|</span> <span class="p">{</span> <span class="err">…</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>或者</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Alternative 0 (as shown): Parameters are outside the lambda block.</span>
</span><span class='line'><span class="o">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="o">].</span><span class="n">each</span> <span class="o">|</span><span class="vg">$value</span><span class="o">|</span> <span class="p">{</span> <span class="n">notice</span> <span class="vg">$value</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Alternative 1: Parameters are inside the lambda block.</span>
</span><span class='line'><span class="o">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="vg">$value</span><span class="o">|</span> <span class="n">notice</span> <span class="vg">$value</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Alternative 2: A fat arrow is placed after the parameters.</span>
</span><span class='line'><span class="o">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="o">].</span><span class="n">each</span> <span class="o">|</span><span class="vg">$value</span><span class="o">|</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">notice</span> <span class="vg">$value</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是我自己实验，只有</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="vg">$value</span><span class="o">|</span> <span class="n">notice</span> <span class="vg">$value</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>的方式成功了。</p>

<p>其实这些函数都是通过添加Puppet自定义函数的形式实现的，lambda表达式作为一个参数进行处理，调一个call就执行了。</p>

<p>比如迭代哈希的关键代码就是这样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">receiver</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>  <span class="n">pblock</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="n">foreach_Hash</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="nb">self</span><span class="p">,</span> <span class="n">pblock</span><span class="p">)</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">foreach_Hash</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">pblock</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="kp">nil</span> <span class="k">unless</span> <span class="n">pblock</span>
</span><span class='line'>      <span class="n">serving_size</span> <span class="o">=</span> <span class="n">pblock</span><span class="o">.</span><span class="n">parameter_count</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">enumerator</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">each_pair</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">serving_size</span> <span class="o">==</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
</span><span class='line'>          <span class="n">pblock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">enumerator</span><span class="o">.</span><span class="n">next</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
</span><span class='line'>          <span class="n">pblock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="o">*</span><span class="n">enumerator</span><span class="o">.</span><span class="n">next</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">o</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>其实还是使用了Ruby中的each_pair这个迭代器。在Puppet中写的lambda表达式还是循环调用，并把each_pair作为每一次的参数传进去用。</p>

<p>感觉Puppet在解释lambda表达式时应该还做了些工作，今天就不研究了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/04/use-hiera-in-puppet/">在Puppet中使用Hiera</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-07-04T23:38:00+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>11:38 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Puppet3.x开始Hiera成为了必需的组件，实现类似ENC的功能，正好现在试试效果。</p>

<p>使用Hiera可以用更格式化的组织节点的定义，而且支持动态的查找加载。</p>

<p>以前在puppetmaster运行过程中加入pp文件，puppet是不会发现并加载此文件的。</p>

<h2>使用</h2>

<p>Puppet3.x自带了Hiera，默认的hiera配置路径是<code>/etc/puppet/hiera.yaml</code>，所以只需要新建此文件，即启用了Hiera。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># hiera.yaml的例子</span>
</span><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">:backends</span><span class="p-Indicator">:</span> <span class="c1"># 搜索yaml和json格式的文件</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">yaml</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">json</span>
</span><span class='line'><span class="l-Scalar-Plain">:yaml</span><span class="p-Indicator">:</span>  <span class="c1"># hiera数据文件的目录</span>
</span><span class='line'>  <span class="l-Scalar-Plain">:datadir</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/puppet/hieradata</span>
</span><span class='line'><span class="l-Scalar-Plain">:json</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">:datadir</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/puppet/hieradata</span>
</span><span class='line'><span class="l-Scalar-Plain">:hierarchy</span><span class="p-Indicator">:</span>  <span class="c1"># 在指定目录搜索以下名称的文件</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{::clientcert}&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{::custom_location}&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">common</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hiera能实现动态加载的主要点就在<code>:hierarchy</code>的配置，此配置项指定Hiera需要读取的数据文件名称，<code>%{::clientcert}</code>表示使用以节点的certname来查找。</p>

<p>比如<code>certname=node1</code>的节点在运行<code>puppet agent --test</code>时，puppetmaster就会去读取<code>node1.yaml</code>和<code>node1.json</code>两个文件。具体可用的变量可以<a href="http://docs.puppetlabs.com/hiera/1/variables.html">在此</a>查看。</p>

<h2>Hiera数据</h2>

<p>具体的Hiera数据可以使用yaml、json、puppet三种格式，puppet格式的目前没有详细文档说明。</p>

<p>这里以yaml格式的为例说明，json格式也差不多，就是会多很多&#8221;&ldquo;。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># node1.yaml</span>
</span><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">string</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">str</span>
</span><span class='line'><span class="l-Scalar-Plain">array</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">  - 1</span>
</span><span class='line'><span class="l-Scalar-Plain">  - 2</span>
</span><span class='line'><span class="l-Scalar-Plain">  - 3</span>
</span><span class='line'><span class="l-Scalar-Plain">hash</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">   key</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">value</span>
</span></code></pre></td></tr></table></div></figure>


<p>你可以自己写一个module，其中的init.pp可以这样写：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># init.pp</span>
</span><span class='line'><span class="l-Scalar-Plain">class my_mod(</span>
</span><span class='line'><span class="l-Scalar-Plain">  $string = hiera(&quot;string&quot;),</span>
</span><span class='line'><span class="l-Scalar-Plain">  $array = hiera_array(&quot;array&quot;),</span>
</span><span class='line'><span class="l-Scalar-Plain">  $hash = hiera_hash(&quot;hash&quot;)</span>
</span><span class='line'><span class="l-Scalar-Plain">) {</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后在<code>site.pp</code>中给node1加上这个class，node1在获取catalog时就会自动的从<code>node1.yaml</code>中加载数据并赋值给<code>$string, $array, $hash</code>三个变量。<code>hiera(), hiera_array(), hiera_hash()</code>是Hiera专门用来搜索数据的函数。</p>

<p>Hiera也支持<strong>自动赋值</strong>，如果你的node1.yaml文件是这样的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># node1.yaml</span>
</span><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">my_mod::string</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">str</span>
</span><span class='line'><span class="l-Scalar-Plain">my_mod::array</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">  - 1</span>
</span><span class='line'><span class="l-Scalar-Plain">  - 2</span>
</span><span class='line'><span class="l-Scalar-Plain">  - 3</span>
</span><span class='line'><span class="l-Scalar-Plain">my_mod::hash</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">   key</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">value</span>
</span></code></pre></td></tr></table></div></figure>


<p>那在my_mod的参数中就不需要再使用函数查找，Hiera会自动关联赋值。</p>

<h2>在Hiera中指定Classes</h2>

<p>如果想完全抛弃<code>site.pp</code>怎么办？用Hiera也可以办到。</p>

<p>只需要在<code>site.pp</code>中加上一句<code>hiera_include("classes")</code>，</p>

<p>在node1.yaml中再添加上classes。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># node1.yaml</span>
</span><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">classes</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">my_mod</span>
</span><span class='line'><span class="l-Scalar-Plain">my_mod::string</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">str</span>
</span><span class='line'><span class="l-Scalar-Plain">my_mod::array</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">  - 1</span>
</span><span class='line'><span class="l-Scalar-Plain">  - 2</span>
</span><span class='line'><span class="l-Scalar-Plain">  - 3</span>
</span><span class='line'><span class="l-Scalar-Plain">my_mod::hash</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">   key</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">value</span>
</span></code></pre></td></tr></table></div></figure>


<p>那么以后节点的classes定义就可以完全通过</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/08/use-git-submodule/">使用Git Submodule</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-06-08T17:12:00+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>5:12 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近clone的项目里面发现使用了Git的Submodule功能，所以在这儿记录一下基本的使用方法</p>

<h3>添加submodule</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git submodule add git@github.com:xxx/submoule.git src/submodule
</span></code></pre></td></tr></table></div></figure>


<p>在项目中就会自动生成一个.gitmodules文件来保存submodule的关系，再提交到远程库就ok了</p>

<h3>clone项目</h3>

<p>在clone带有submodule的项目，直接使用<code>--recursive</code>就可以递归地将所有submodule，包括submodule中的submodule都一次性clone到本地</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git clone --recursive git@github.com:xxx/xxx.git
</span></code></pre></td></tr></table></div></figure>


<p>不然就得使用如下的命令组合来完成初次clone，这样还不能clone到submodule中的submodule</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git clone git@github.com:xxx/xxx.git
</span><span class='line'>git submodule init    <span class="c"># 将.gitmodules中的内容注册到.git/config中</span>
</span><span class='line'>git submodule update  <span class="c"># clone submodule并且checkout指定commit</span>
</span></code></pre></td></tr></table></div></figure>


<h3>更新项目</h3>

<p>如果你不会到submodule中进行开发，那么每次submodule有了更新只需要再update一次就行了</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git pull origin master
</span><span class='line'>git submodule update --recursive <span class="c"># 必须在项目顶层目录执行此命令，也可以添加--init保证init执行</span>
</span></code></pre></td></tr></table></div></figure>


<h3>更新submodule</h3>

<p>submodule其实也就是一个单独的Git repo，只是会在项目顶层目录的.gitmodules目录中记录下路径和submodule源的映射关系</p>

<pre><code># .gitmodules的内容
[submodule "src/cloud_controller_ng"]
    path = src/cloud_controller_ng
    url = https://github.com/cloudfoundry/cloud_controller_ng.git
</code></pre>

<p>但是这个文件中并没有指定submodule的commit id，git怎么知道该用submodule的哪个commit呢？</p>

<p>在顶层项目的<code>.git/modules</code>里会保存submodule的git配置，同时也就知道了使用的是submodule的哪个commit
而submodule的.git则只是记录了一下路径</p>

<pre><code># submodule目录中的.git的内容
gitdir: ../.git/modules/dea
</code></pre>

<p>所以在submodule中进行commit或者push就和普通repo完全一样，只是最后需要在外层repo中更新一下</p>

<p>现在假设已经在submodule目录或者单独的submodule项目目录中完成了<code>add</code>、<code>commit</code>和<code>push</code>操作，或者执行了<code>git pull</code>获取了新的源码
这时需要回到外层项目，再次更新一遍</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git status  <span class="c"># 会提示submodule有new commit</span>
</span><span class='line'>git add .   <span class="c"># 添加更改</span>
</span><span class='line'>git commit -m <span class="s2">&quot;update submoule&quot;</span>
</span><span class='line'>git push
</span></code></pre></td></tr></table></div></figure>


<p>在另一个项目repo中执行以下命令，就可以将submodule的commit同步了</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git pull
</span><span class='line'>git submodule update --recursive  <span class="c"># 可以加上--init</span>
</span></code></pre></td></tr></table></div></figure>


<h3>其他</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git submoule foreach <span class="s1">&#39;echo $path `git rev-parse HEAD`&#39;</span>  <span class="c"># foreach 可以对每个submodule执行shell命令</span>
</span><span class='line'>
</span><span class='line'>git <span class="nb">help </span>submodule   <span class="c"># git帮助文档</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/11/use-awk-to-diff-file/">使用awk比较文件</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-05-11T18:46:00+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>6:46 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>平时在CLI环境里面需要经常比较两个小文件的内容，最近专门搜索了下，收集了两个简单的比较方案。</p>

<h3>方案1：</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>cat a | grep -vFf b
</span></code></pre></td></tr></table></div></figure>


<p>如果想要不区分大小写，加-i参数即可</p>

<h3>方案2：</h3>

<p>如果数据量到达1000w以上，grep很容易占满内存，无法使用</p>

<p>这个时候就需要使用awk了</p>

<p>比如要比较a和b两个文件；
a             b
1             1
qw            2
qq            d
123           cd</p>

<p>列出b文件中完全不包含a文件的行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='awk'><span class='line'><span class="nx">awk</span> <span class="s1">&#39;ARGIND==1 {arr[$0]} ARGIND&gt;1&amp;&amp;!($0 in arr) {print $0}&#39;</span> <span class="nx">a</span> <span class="nx">b</span>
</span><span class='line'>
</span><span class='line'><span class="nx">awk</span> <span class="s1">&#39;NR==FNR {arr[$0]} NR&gt;FNR&amp;&amp;!($0 in arr) {print $0}&#39;</span> <span class="nx">a</span> <span class="nx">b</span>
</span></code></pre></td></tr></table></div></figure>


<p>解释：</p>

<p>首先awk会按顺序先处理a文件，在处理b文件；</p>

<p>然后根据awk的环境变量列表：</p>

<pre><code>$n           当前记录的第n个字段，字段间由FS分隔。
$0           完整的输入记录。
ARGC         命令行参数的数目。
ARGIND       命令行中当前文件的位置(从0开始算)。
ARGV         包含命令行参数的数组。
CONVFMT      数字转换格式(默认值为%.6g)
ENVIRON      环境变量关联数组。
ERRNO        最后一个系统错误的描述。
FIELDWIDTHS  字段宽度列表(用空格键分隔)。
FILENAME     当前文件名。FNR同NR，但相对于当前文件。
FS           字段分隔符(默认是任何空格)。
IGNORECASE   如果为真，则进行忽略大小写的匹配。
NF           当前记录中的字段数。
NR           当前记录数。
OFMT         数字的输出格式(默认值是%.6g)。
OFS          输出字段分隔符(默认值是一个空格)。
ORS          输出记录分隔符(默认值是一个换行符)。
RLENGTH      由match函数所匹配的字符串的长度。
RS           记录分隔符(默认是一个换行符)。 
RSTART       由match函数所匹配的字符串的第一个位置。
SUBSEP       数组下标分隔符(默认值是\034)。
</code></pre>

<p>NR==FNR时是在处理a，将当前行放入数组</p>

<p>NR>FNR时是在处理b，如果当前行不在数组中，则打印</p>

<p>相应的ARGIND==1 正在处理a，ARGIND > 1 正在处理文件b</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/09/install-ruby2-dot-0/">Ruby2.0关键字参数使用小记</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-04-09T11:26:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>11:26 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Ruby2.0发布了，于是下来试试手。
下载了源码包，直接<code>./configure &amp;&amp; make &amp;&amp; make install</code>安装，没加特殊的flag。</p>

<p>安装过程中出现了几个问题：</p>

<ul>
<li>系统时间不对，在<code>make</code>的时候检查文件时间戳出错，不断的重复执行<code>configure</code>，使用ntp服务同步时间解决</li>
<li>在pry环境中不能使用上下方向键，错误信息是rb-readline有问题，在pry的 <a href="https://github.com/pry/pry/issues/863/">Github Issues</a> 里面找到问题，是rb-readline版本问题，重新安装最新版本解决</li>
</ul>


<p>然后试用了几个2.0的新特性，对我来说<code>关键字参数</code>最适用，其他几个<code>Refinements</code>、<code>Lazy enumerables</code>、<code>Module prepending</code>平时元编程和函数编程用得不多，暂时用不上。</p>

<p>对于关键字参数，Python里面已经有了，没什么好说的。</p>

<p>Ruby中关键字参数的两个要点：</p>

<ul>
<li>位置：定义的时候只能是 <code>a, *b, c: 1, **d, &amp;e</code> 的顺序</li>
<li>使用：调用时必须指明参数名称。这点和Python不同，Python可以根据参数的顺序来推断。</li>
</ul>


<p>对于如下定义的函数</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">c</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">print</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>调用时使用<code>func(4,5,6)</code>会提示<code>wrong number of arguments</code>，
只能是<code>func(a: 4, b: 5, c: 6)</code>的形式，这个时候顺序可以随意了。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/01/14/use-spark-with-elasticsearch/">使用Spark对ElasticSearch进行读取</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/02/angular-plus-springmvc/">AngularJS+SpringMVC构建应用</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/02/ruby2-dot-0/">Ruby和Ruby2.0相关文章汇总</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/17/check-logfiles/">在Nagios中实时监控日志</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/08/a-bug-of-facter/">Facter在Windows上的一个小问题</a>
      </li>
    
  </ul>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Darcy Tang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'darcytang';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
